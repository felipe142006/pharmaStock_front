<app-navbar></app-navbar>

<div class="max-w-screen-xl mx-auto px-4 py-6">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Ventas</h1>
      <p class="text-sm text-gray-500">Registra y consulta tus ventas</p>
    </div>
    <button
      class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-white font-semibold shadow hover:bg-emerald-700"
      (click)="openCreate()"
    >
      <i class="fas fa-plus"></i> Nueva venta
    </button>
  </div>

  @if (loading()) {
  <div class="w-full flex items-center justify-center py-16 text-gray-600">
    <i class="fas fa-spinner fa-spin fa-2x"></i>
    <span class="ml-3">Cargando ventas…</span>
  </div>
  } @else {
  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-gray-600 uppercase text-xs tracking-wider">
        <tr>
          <th class="px-4 py-3 text-left">Factura</th>
          <th class="px-4 py-3 text-left">Cliente</th>
          <th class="px-4 py-3 text-left">Fecha</th>
          <th class="px-4 py-3 text-left">Total</th>
          <th class="px-4 py-3 text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (sale of sales(); track trackById($index, sale)) {
        <tr class="border-b hover:bg-gray-50 transition">
          <td class="px-4 py-2 font-mono">{{ sale.invoice_number }}</td>
          <td class="px-4 py-2">{{ sale.customer?.name || "—" }}</td>
          <td class="px-4 py-2">{{ sale.issued_at | date : "short" }}</td>
          <td class="px-4 py-2">$ {{ sale.total | number : "1.0-0" }}</td>
          <td class="px-4 py-2 text-center">
            <button
              class="text-sky-600 hover:text-sky-800 mx-1"
              type="button"
              (click)="openView(sale.id)"
              title="Ver detalle"
            >
              <i class="fas fa-eye"></i>
            </button>
            <button
              class="text-indigo-600 hover:text-indigo-800 mx-1"
              (click)="downloadPDF(sale)"
            >
              <i class="fas fa-file-pdf"></i>
            </button>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-gray-500">
            No hay ventas registradas.
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }
</div>

<!-- modal de venta -->
<ng-template #saleModal>
  <div class="modal-header">
    <h4 class="modal-title text-gray-900 font-semibold">Nueva venta</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="closeModal()"
    ></button>
  </div>

  <div class="modal-body">
    <!-- PASO 1: seleccionar cliente -->
    @if (step() === 1) {
    <form [formGroup]="step1Form" class="space-y-4">
      <div class="text-sm text-gray-600">
        Selecciona cómo asociar el cliente a la venta:
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <label
          class="border rounded-lg p-3 flex items-center gap-2 cursor-pointer"
        >
          <input
            type="radio"
            value="registered"
            formControlName="mode"
            (change)="onModeChange()"
          />
          <span>Cliente registrado</span>
        </label>

        <label
          class="border rounded-lg p-3 flex items-center gap-2 cursor-pointer"
        >
          <input
            type="radio"
            value="new"
            formControlName="mode"
            (change)="onModeChange()"
          />
          <span>Registrar nuevo cliente</span>
        </label>

        <label
          class="border rounded-lg p-3 flex items-center gap-2 cursor-pointer"
        >
          <input
            type="radio"
            value="none"
            formControlName="mode"
            (change)="onModeChange()"
          />
          <span>Continuar sin cliente</span>
        </label>
      </div>

      <!-- cliente registrado -->
      @if (step1Form.value.mode === 'registered') {
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <label class="block text-xs font-medium text-gray-600"
            >Documento</label
          >
          <input
            type="text"
            formControlName="search_document"
            placeholder="CC/NIT/Pasaporte"
            class="w-full rounded-lg border-2 px-3 py-2 outline-none border-gray-200 focus:border-emerald-500"
          />
        </div>

        <div class="flex items-end">
          <button
            type="button"
            class="w-full md:w-auto rounded-lg bg-sky-600 px-4 py-2 text-white font-semibold hover:bg-sky-700"
            (click)="searchCustomer()"
          >
            <i class="fas fa-search"></i> Buscar
          </button>
        </div>

        @if (selectedCustomerId()) {
        <div class="text-sm text-emerald-700 col-span-full">
          Cliente seleccionado: {{ selectedCustomerName() }}
        </div>
        }
      </div>
      }

      <!-- nuevo cliente -->
      @if (step1Form.value.mode === 'new') {
      <div
        formGroupName="new_customer"
        class="grid grid-cols-1 md:grid-cols-2 gap-3"
      >
        <div>
          <label class="block text-xs font-medium text-gray-600"
            >Documento*</label
          >
          <input
            type="text"
            formControlName="document"
            class="w-full rounded-lg border-2 px-3 py-2 outline-none border-gray-200 focus:border-emerald-500"
          />
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-600">Nombre*</label>
          <input
            type="text"
            formControlName="name"
            class="w-full rounded-lg border-2 px-3 py-2 outline-none border-gray-200 focus:border-emerald-500"
          />
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-600">Email</label>
          <input
            type="email"
            formControlName="email"
            class="w-full rounded-lg border-2 px-3 py-2 outline-none border-gray-200 focus:border-emerald-500"
          />
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-600"
            >Teléfono*</label
          >
          <input
            type="text"
            formControlName="phone"
            class="w-full rounded-lg border-2 px-3 py-2 outline-none border-gray-200 focus:border-emerald-500"
          />
        </div>

        <div class="md:col-span-2">
          <label class="block text-xs font-medium text-gray-600"
            >Dirección</label
          >
          <input
            type="text"
            formControlName="address"
            class="w-full rounded-lg border-2 px-3 py-2 outline-none border-gray-200 focus:border-emerald-500"
          />
        </div>
      </div>
      }
    </form>
    }

    <!-- PASO 2: detalle de la venta -->
    @if (step() === 2) {
    <form [formGroup]="step2Form" class="space-y-4">
      <div class="bg-gray-50 rounded-lg p-3 text-xs text-gray-600">
        IVA aplicado: <b>19%</b> • Fecha: {{ todayStr }}
        <span *ngIf="selectedCustomerName()"
          >• Cliente: {{ selectedCustomerName() }}</span
        >
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left">Producto</th>
              <th class="px-3 py-2 text-left">Precio</th>
              <th class="px-3 py-2 text-left">Stock</th>
              <th class="px-3 py-2 text-left">Cantidad</th>
              <th class="px-3 py-2 text-left">Descuento</th>
              <th class="px-3 py-2 text-left">Total</th>
              <th class="px-3 py-2"></th>
            </tr>
          </thead>

          <tbody [formGroup]="step2Form">
            @for (row of itemsFA.controls; track trackByIndex($index)) {
            <tr [formGroup]="row" class="border-b">
              <td class="px-3 py-2">
                <select
                  class="w-64 rounded-lg border-2 px-2 py-1 outline-none border-gray-200 focus:border-emerald-500"
                  formControlName="product_id"
                  (change)="onSelectProduct($index)"
                >
                  <option [ngValue]="null">— Selecciona —</option>
                  @for (p of products(); track p.id) {
                  <option
                    [ngValue]="p.id"
                    [disabled]="
                      isProductDisabled(p.id, $index) ||
                      (p.expires_at && p.expires_at < todayStr) ||
                      !p.is_active
                    "
                  >
                    {{ p.sku }} — {{ p.name }}
                  </option>
                  }
                </select>
              </td>

              <td class="px-3 py-2">
                $ {{ row.get("unit_price")?.value || 0 | number : "1.0-0" }}
              </td>

              <td class="px-3 py-2">
                {{ row.get("max_stock")?.value || 0 }}
              </td>

              <td class="px-3 py-2">
                <input
                  type="number"
                  min="1"
                  class="w-24 rounded-lg border-2 px-2 py-1 outline-none border-gray-200 focus:border-emerald-500"
                  formControlName="quantity"
                  (input)="onQuantityInput($index)"
                  (blur)="onQuantityBlur($index)"
                />
              </td>

              <td class="px-3 py-2">
                <input
                  type="number"
                  min="0"
                  class="w-24 rounded-lg border-2 px-2 py-1 outline-none border-gray-200 focus:border-emerald-500"
                  formControlName="discount"
                  (input)="onQtyOrDiscountChange($index)"
                  (blur)="onQtyOrDiscountChange($index)"
                />
              </td>

              <td class="px-3 py-2">
                $ {{ row.get("line_total")?.value || 0 | number : "1.0-0" }}
              </td>

              <td class="px-3 py-2 text-right">
                <button
                  class="text-rose-600 hover:text-rose-800"
                  type="button"
                  (click)="removeItem($index)"
                >
                  <i class="fas fa-times"></i>
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <div>
        <button
          type="button"
          class="rounded-lg bg-gray-100 px-3 py-1 text-sm hover:bg-gray-200"
          (click)="addItem()"
        >
          <i class="fas fa-plus"></i> Agregar producto
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-2"></div>
        <div class="bg-white rounded-lg border p-3 text-sm space-y-1">
          <div class="flex justify-between">
            <span>Subtotal:</span><b>$ {{ subtotal | number : "1.0-0" }}</b>
          </div>
          <div class="flex justify-between">
            <span>IVA (19%):</span><b>$ {{ tax | number : "1.0-0" }}</b>
          </div>
          <div class="flex justify-between text-lg">
            <span>Total:</span><b>$ {{ total | number : "1.0-0" }}</b>
          </div>
        </div>
      </div>
    </form>
    }
  </div>

  <div class="modal-footer">
    @if (step() === 1) {
    <button type="button" class="btn btn-secondary" (click)="closeModal()">
      Cancelar
    </button>
    <button type="button" class="btn btn-primary" (click)="goToStep2()">
      Continuar
    </button>
    @if (step1Form.value.mode === 'new') {
    <button
      type="button"
      class="btn btn-emerald"
      (click)="createCustomerThenContinue()"
    >
      Crear cliente y continuar
    </button>
    } } @if (step() === 2) {
    <button type="button" class="btn btn-secondary" (click)="step.set(1)">
      Volver
    </button>
    <button
      type="button"
      class="btn btn-primary inline-flex items-center gap-2"
      [disabled]="formLoading()"
      (click)="saveSale()"
    >
      @if (!formLoading()) { <i class="fas fa-save"></i> Guardar venta } @else {
      <i class="fas fa-spinner fa-spin"></i> Procesando… }
    </button>
    }
  </div>
</ng-template>

<!-- modal de ver una venta -->
<ng-template #saleDetailModal>
  <div class="modal-header">
    <h4 class="modal-title text-gray-900 font-semibold">
      Detalle de venta
      <span class="text-gray-500 ml-2" *ngIf="saleDetail() as d">
        {{ d?.invoice_number }}
      </span>
    </h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="closeModal()"
    ></button>
  </div>

  <div class="modal-body">
    @if (detailLoading()) {
    <div class="w-full flex items-center justify-center py-12 text-gray-600">
      <i class="fas fa-spinner fa-spin fa-2x"></i>
      <span class="ml-3">Cargando detalle…</span>
    </div>
    } @else { @if (saleDetail(); as d) {
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 rounded-lg p-3">
          <div class="text-xs text-gray-500">Factura</div>
          <div class="text-sm font-semibold">{{ d?.invoice_number }}</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-3">
          <div class="text-xs text-gray-500">Fecha emisión</div>
          <div class="text-sm font-semibold">
            {{ d?.issued_at | date : "yyyy-MM-dd HH:mm" }}
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl border p-4">
        <div class="text-sm font-semibold mb-2">Cliente</div>
        @if (d?.customer) {
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <div>
            <span class="text-gray-500">Nombre:</span>
            {{ d.customer?.name || "—" }}
          </div>
          <div>
            <span class="text-gray-500">Documento:</span>
            {{ d.customer?.document || "—" }}
          </div>
          <div>
            <span class="text-gray-500">Email:</span>
            {{ d.customer?.email || "—" }}
          </div>
          <div>
            <span class="text-gray-500">Teléfono:</span>
            {{ d.customer?.phone || "—" }}
          </div>
          <div class="md:col-span-2">
            <span class="text-gray-500">Dirección:</span>
            {{ d.customer?.address || "—" }}
          </div>
        </div>
        } @else {
        <div class="text-sm text-gray-600 italic">
          Venta sin cliente asociado.
        </div>
        }
      </div>

      <div class="bg-white rounded-xl border overflow-hidden">
        <table class="min-w-full text-sm">
          <thead
            class="bg-gray-50 text-gray-600 uppercase text-xs tracking-wider"
          >
            <tr>
              <th class="px-3 py-2 text-left">Código</th>
              <th class="px-3 py-2 text-left">Producto</th>
              <th class="px-3 py-2 text-right">Cantidad</th>
              <th class="px-3 py-2 text-right">Precio</th>
              <th class="px-3 py-2 text-right">Descuento</th>
              <th class="px-3 py-2 text-right">Total</th>
            </tr>
          </thead>
          <tbody>
            @for (it of (d?.items ?? []); track it.id) {
            <tr class="border-b">
              <td class="px-3 py-2 font-mono">{{ it?.product?.sku || "—" }}</td>
              <td class="px-3 py-2">{{ it?.product?.name || "—" }}</td>
              <td class="px-3 py-2 text-right">{{ it?.quantity }}</td>
              <td class="px-3 py-2 text-right">
                $ {{ it?.unit_price || 0 | number : "1.0-0" }}
              </td>
              <td class="px-3 py-2 text-right">
                $ {{ it?.discount || 0 | number : "1.0-0" }}
              </td>
              <td class="px-3 py-2 text-right">
                $ {{ it?.line_total || 0 | number : "1.0-0" }}
              </td>
            </tr>
            } @empty {
            <tr>
              <td colspan="6" class="px-3 py-6 text-center text-gray-500">
                Sin ítems
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="flex flex-col md:flex-row md:justify-end">
        <div class="w-full md:w-96 bg-gray-50 rounded-xl border p-4 text-sm">
          <div class="flex justify-between py-1">
            <span class="text-gray-600">Subtotal</span>
            <span>$ {{ d?.subtotal || 0 | number : "1.0-0" }}</span>
          </div>
          <div class="flex justify-between py-1">
            <span class="text-gray-600">Descuento</span>
            <span>$ {{ d?.discount || 0 | number : "1.0-0" }}</span>
          </div>
          <div class="flex justify-between py-1">
            <span class="text-gray-600">IVA (19%)</span>
            <span>$ {{ d?.tax || 0 | number : "1.0-0" }}</span>
          </div>
          <div class="border-t my-2"></div>
          <div class="flex justify-between py-1 font-semibold text-gray-900">
            <span>Total</span>
            <span>$ {{ d?.total || 0 | number : "1.0-0" }}</span>
          </div>
        </div>
      </div>

      <div class="text-xs text-gray-500">
        @if (d?.user) {
        <div>Usuario que generó: {{ d.user?.name || "—" }}</div>
        } @if (d?.printed_at) {
        <div>Impresa: {{ d.printed_at | date : "yyyy-MM-dd HH:mm" }}</div>
        }
      </div>
    </div>
    } @else {
    <div class="text-center text-gray-600">
      No se encontraron datos de la venta.
    </div>
    } }
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">
      Cerrar
    </button>
  </div>
</ng-template>
